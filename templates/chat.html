{% extends "base.html" %}
{% block title %}–ß–∞—Ç —Å {{ partner }} | malpire.ru{% endblock %}
{% block body_class %}chat-layout{% endblock %}

{% block content %}
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="search-container">
            <input type="text" id="userSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π..." autocomplete="off">
            <div class="search-results" id="searchResults"></div>
        </div>

        <h2>–ß–∞—Ç—ã</h2>
        <div id="chats-list">
            {% for chat in chats %}
                <div class="chat-item">
                    <a href="/chat/{{ chat.chat_id }}" class="{{ 'active-chat' if chat.partner_username == partner }} {{ 'unread' if chat.unread_count > 0 }}">
                        <div class="user-info">
                            <span class="status-dot {% if statuses[chat.partner_username].online %}online{% else %}offline{% endif %}"></span>
                            <strong>{{ chat.partner_username }}</strong>
                            {% if chat.unread_count > 0 %}
                                <span class="unread-badge">{{ chat.unread_count }}</span>
                            {% endif %}
                        </div>
                        <span class="last-message" title="{{ chat.last_message_content or '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π' }}">
                            {% if chat.last_message_content %}
                                {{ chat.last_message_content|truncate(30, True) }}
                            {% else %}
                                –ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π
                            {% endif %}
                        </span>
                    </a>
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- Chat Area -->
<div class="chat-container">
    <!-- –®–∞–ø–∫–∞ —á–∞—Ç–∞ -->
    <div class="chat-header">
        <div class="menu-toggle" id="menuToggle">
            <span></span>
        </div>
        <img src="{{ statuses[partner].avatar_url }}" class="partner-avatar">
        <div class="partner-info">
            <div class="chat-title">
                {{ partner }}
                {% if statuses[partner].is_admin %}
                    <img src="/static/verified.png" class="admin-badge" title="–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä">
                {% endif %}
            </div>
            <div class="partner-status">
                <span class="status-dot {% if statuses[partner].online %}online{% else %}offline{% endif %}"></span>
                {% if statuses[partner].online %}
                    <span>–æ–Ω–ª–∞–π–Ω</span>
                {% else %}
                    <span>–±—ã–ª(–∞) {{ statuses[partner].last_seen }}</span>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- –û–±–ª–∞—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π -->
    <div id="chat-box">
        {% for message in messages %}
            <div class="message-container {{ 'my-message' if message.sender_id == current_user_id else 'their-message' }}">
                {% if message.sender_id != current_user_id %}
                    <div class="avatar-container">
                        <img src="{{ statuses[message.sender_username].avatar_url }}"
                             class="message-avatar">
                    </div>
                {% endif %}

                <div class="message-bubble">
                    {% if message.content %}
                        <div class="message-text">{{ message.content }}</div>
                    {% endif %}

                    {% if message.attachments %}
                        <div class="message-attachments">
                            {% for attachment in message.attachments %}
                                {% if attachment.file_type == 'image' %}
                                    <div class="attachment">
                                        <img src="{{ attachment.file_url }}"
                                             class="attachment-image"
                                             onclick="window.open('{{ attachment.file_url }}', '_blank')">
                                    </div>
                                {% else %}
                                    <div class="attachment">
                                        <a href="{{ attachment.file_url }}" target="_blank">
                                            üìÑ {{ attachment.file_name|truncate(20) }}
                                        </a>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    {% endif %}

                    <time datetime="{{ message.timestamp.isoformat() }}">
                        {{ message.timestamp.strftime('%H:%M') }}
                    </time>
                </div>
            </div>
        {% endfor %}
    </div>

    <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ -->
    <div class="input-area">
        <div class="attachment-preview hidden" id="attachmentPreview"></div>

        <div class="input-wrapper">
            <input type="text"
                   id="messageInput"
                   placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
                   autocomplete="off">

            <label for="fileInput" class="file-upload-button" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª">
                üìé
                <input type="file"
                       id="fileInput"
                       style="display: none;"
                       multiple>
            </label>

            <button id="sendButton" onclick="sendMessage()">
                –û—Ç–ø—Ä–∞–≤–∏—Ç—å
            </button>
        </div>
    </div>
</div>
    <audio id="notificationSound" hidden>
        <source src="/static/notification.mp3" type="audio/mpeg">
    </audio>
    </div>
    <div id="profileModal" class="modal">
        <div class="modal-blur-bg"></div>
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <div id="profileModalContent"></div>
        </div>
    </div>
    <script>
        const chatId = {{ chat_id }};
        const currentUserId = {{ request.session.get('user_id') }};
        const currentUsername = "{{ current_user.username }}";
        const currentPartner = "{{ partner }}";
        const statuses = JSON.parse('{{ statuses|tojson|safe }}');
        let ws = null;
        let attachments = [];

        // –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ WebSocket
        function initWebSocket() {
            if (ws) {
                ws.close();
            }

            const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
	        ws = new WebSocket(`${protocol}${window.location.host}/ws/chat/${chatId}?user_id=${currentUserId}&current_chat_id=${chatId}`);

            ws.onopen = function() {
                console.log("WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ");
                requestChatsUpdate();
            };

            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);

                    if (data.action === "update_chats") {
                        updateChatsList(data.chats);
                        return;
                    }

                    if (data.action === "new_message") {
                        handleNewMessage(data);
                    }
                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è WebSocket:", error);
                }
            };

            ws.onerror = function(error) {
                console.error("WebSocket –æ—à–∏–±–∫–∞:", error);
            };

            ws.onclose = function() {
                console.log("WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ");
                setTimeout(initWebSocket, 5000); // –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            };
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        function handleNewMessage(data) {
            const chatBox = document.getElementById("chat-box");
            if (!chatBox) return;

            const messageContainer = document.createElement("div");
            messageContainer.className = `message-container ${data.sender_id == currentUserId ? "my-message" : "their-message"}`;

            let messageContent = `
                <div class="message-bubble">
                    ${data.content ? `<div class="message-text">${data.content}</div>` : ''}
            `;

            if (data.attachments && data.attachments.length > 0) {
                messageContent += `<div class="message-attachments">`;
                data.attachments.forEach(attachment => {
                    if (attachment.file_type === 'image') {
                        messageContent += `
                            <div class="attachment">
                                <img src="${attachment.file_url}" class="attachment-image"
                                     onclick="window.open('${attachment.file_url}', '_blank')">
                            </div>`;
                    } else {
                        messageContent += `
                            <div class="attachment">
                                <a href="${attachment.file_url}" target="_blank">${attachment.file_name}</a>
                            </div>`;
                    }
                });
                messageContent += `</div>`;
            }

            messageContent += `
                    <time>${new Date(data.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</time>
                </div>
            `;

            if (data.sender_id != currentUserId) {
                const avatarUrl = statuses[data.sender_username]?.avatar_url || '/static/default_avatar.png';
                messageContainer.innerHTML = `
                    <div class="avatar-container">
                        <img src="${avatarUrl}" class="message-avatar">
                    </div>
                    ${messageContent}
                `;
            } else {
                messageContainer.innerHTML = messageContent;
            }

            chatBox.appendChild(messageContainer);
            chatBox.scrollTop = chatBox.scrollHeight;

            const isChatActive = document.hasFocus();

            if (!isChatActive || data.chat_id !== chatId) {
                showNotification(
                    `–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç ${data.sender_username}`,
                    data.content || '–í–ª–æ–∂–µ–Ω–∏–µ',
                    `/chat/${data.chat_id}`
                );
            }
        }

        function showNotification(title, body, url) {
            if (!("Notification" in window)) return;
            if (Notification.permission === "granted") {
                createNotification(title, body, url);
            }
            else if (Notification.permission !== "denied") {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        createNotification(title, body, url);
                    }
                });
            }
        }

        function createNotification(title, body, url) {
            const notification = new Notification(title, {
                body,
                icon: '/static/icon.png',
                vibrate: [200, 100, 200]
            });

            notification.onclick = () => {
                window.open(url, '_blank');
                notification.close();
            };
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        function formatLastSeen(timestamp) {
            if (!timestamp) return '–¥–∞–≤–Ω–æ';
            const now = new Date();
            const lastSeen = new Date(timestamp);
            const diff = Math.floor((now - lastSeen) / 1000);

            if (diff < 60) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
            if (diff < 3600) return `${Math.floor(diff/60)} –º–∏–Ω –Ω–∞–∑–∞–¥`;
            if (diff < 86400) return `${Math.floor(diff/3600)} —á –Ω–∞–∑–∞–¥`;
            return `${Math.floor(diff/86400)} –¥–Ω –Ω–∞–∑–∞–¥`;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        async function updateUserStatuses() {
            try {
                const response = await fetch('/api/user_statuses');
                const newStatuses = await response.json();

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å—ã –≤ —Å–ø–∏—Å–∫–µ —á–∞—Ç–æ–≤
                const chatItems = document.querySelectorAll('.chat-item');
                if (chatItems) {
                    chatItems.forEach(item => {
                        const usernameElement = item.querySelector('strong');
                        if (usernameElement) {
                            const username = usernameElement.textContent;
                            const statusDot = item.querySelector('.status-dot');
                            const statusText = item.querySelector('.last-activity');

                            if (statusDot && newStatuses[username]) {
                                statusDot.className = 'status-dot ' + (newStatuses[username].online ? 'online' : 'offline');
                            }

                            if (statusText && newStatuses[username]) {
                                statusText.textContent = newStatuses[username].online
                                    ? '–æ–Ω–ª–∞–π–Ω'
                                    : `–±—ã–ª(–∞) ${formatLastSeen(newStatuses[username].last_seen)}`;
                            }
                        }
                    });
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ —á–∞—Ç–∞
                if (newStatuses[currentPartner]) {
                    const headerStatus = document.querySelector('.partner-status .status-dot');
                    const statusText = document.querySelector('.partner-status');

                    if (headerStatus) {
                        headerStatus.className = 'status-dot ' + (newStatuses[currentPartner].online ? 'online' : 'offline');
                    }

                    if (statusText) {
                        statusText.innerHTML = `
                            <span class="status-dot ${newStatuses[currentPartner].online ? 'online' : 'offline'}"></span>
                            ${newStatuses[currentPartner].online ? '–æ–Ω–ª–∞–π–Ω' : `–±—ã–ª(–∞) ${formatLastSeen(newStatuses[currentPartner].last_seen)}`}
                        `;
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤:', error);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤
        function updateChatsList(chats) {
            const chatsList = document.getElementById('chats-list');
            if (!chatsList) return;

            let html = '';

            if (chats && chats.length > 0) {
                chats.forEach(chat => {
                    const isActive = chat.partner_username === currentPartner;
                    const lastMessage = chat.last_message_content || '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π';
                    const truncatedMessage = lastMessage.length > 30
                        ? lastMessage.substring(0, 30) + '...'
                        : lastMessage;

                    html += `
                    <div class="chat-item">
                        <a href="/chat/${chat.chat_id}" class="${isActive ? 'active-chat' : ''} ${chat.unread_count > 0 ? 'unread' : ''}">
                            <div class="user-info">
                                <span class="status-dot ${chat.partner_username in statuses && statuses[chat.partner_username].online ? 'online' : 'offline'}"></span>
                                <strong>${chat.partner_username}</strong>
                                ${chat.unread_count > 0 ? `<span class="unread-badge">${chat.unread_count}</span>` : ''}
                            </div>
                            <span class="last-message" title="${lastMessage}">${truncatedMessage}</span>
                        </a>
                    </div>`;
                });
            } else {
                html = '<p>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —á–∞—Ç–æ–≤</p>';
            }

            chatsList.innerHTML = html;
        }

        // –ó–∞–ø—Ä–æ—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤
        function requestChatsUpdate() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    action: "get_chats",
                    sender_id: currentUserId
                }));
            }
        }

        // –§—É–Ω–∫—Ü–∏—è —Å–±—Ä–æ—Å–∞ —Å—á–µ—Ç—á–∏–∫–∞ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞
        function resetUnreadCounter() {
            const chatLinks = document.querySelectorAll('#chats-list a');
            chatLinks.forEach(link => {
                if (link.getAttribute('href') === `/chat/${chatId}`) {
                    const badge = link.querySelector('.unread-badge');
                    if (badge) {
                        badge.remove();
                    }
                    link.classList.remove('unread');
                }
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–≤—É–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        function playNotificationSound() {
            const sound = document.getElementById('notificationSound');
            if (sound) {
                sound.currentTime = 0;
                sound.play().catch(e => console.log("–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∑–≤—É–∫:", e));
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤–ª–æ–∂–µ–Ω–∏–π
        document.getElementById('fileInput')?.addEventListener('change', function(e) {
            const files = e.target.files;
            const previewContainer = document.querySelector('.attachment-preview');

            if (files.length > 0) {
                previewContainer.classList.remove('hidden');
                previewContainer.innerHTML = '';
                attachments = []; // –û—á–∏—â–∞–µ–º –º–∞—Å—Å–∏–≤ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤

                for (let i = 0; i < files.length; i++) {
                    attachments.push(files[i]); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª—ã –≤ –º–∞—Å—Å–∏–≤
                    displayAttachmentPreview(files[i]);
                }
            } else {
                previewContainer.classList.add('hidden');
                attachments = [];
            }
        });

        function displayAttachmentPreview(file) {
            const previewContainer = document.querySelector('.attachment-preview');
            const previewItem = document.createElement('div');
            previewItem.className = 'attachment-item';

            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'attachment-image';
                    previewItem.appendChild(img);
                    addRemoveButton(previewItem, file);
                    previewContainer.appendChild(previewItem);
                };
                reader.readAsDataURL(file);
            } else {
                previewItem.textContent = file.name;
                addRemoveButton(previewItem, file);
                previewContainer.appendChild(previewItem);
            }
        }

        function addRemoveButton(container, file) {
            const removeBtn = document.createElement('div');
            removeBtn.className = 'remove-attachment';
            removeBtn.innerHTML = '√ó';
            removeBtn.onclick = function() {
                // –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª –∏–∑ –º–∞—Å—Å–∏–≤–∞ attachments
                attachments = attachments.filter(f => f.name !== file.name && f.size !== file.size);
                container.remove();
                updateAttachmentPreview();
            };
            container.appendChild(removeBtn);
        }


        function updateAttachmentPreview() {
            const previewContainer = document.querySelector('.attachment-preview');
            if (previewContainer.children.length === 0) {
                previewContainer.classList.add('hidden');
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
        async function sendMessage() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                console.error("WebSocket –Ω–µ –≥–æ—Ç–æ–≤ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏–π");
                return;
            }

            const input = document.getElementById("messageInput");
            const content = input?.value.trim();
            const hasContent = content && content.length > 0;
            const hasAttachments = attachments.length > 0;

            if (!hasContent && !hasAttachments) return;

            try {
                let uploadedFiles = [];

                // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–æ–≤, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
                if (hasAttachments) {
                    const formData = new FormData();
                    attachments.forEach(file => {
                        formData.append('files', file);
                    });

                    const uploadResponse = await fetch(`/upload_attachment/${chatId}`, {
                        method: 'POST',
                        body: formData
                    });

                    if (!uploadResponse.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤');
                    uploadedFiles = await uploadResponse.json();
                }

                // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ WebSocket
                ws.send(JSON.stringify({
                    action: "send_message",
                    sender_id: currentUserId,
                    content: content || '',
                    chat_id: chatId,
                    attachments: uploadedFiles
                }));

                // –û—á–∏—Å—Ç–∫–∞ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
                if (input) input.value = "";
                attachments = [];
                document.querySelector('.attachment-preview').innerHTML = '';
                document.querySelector('.attachment-preview').classList.add('hidden');
                document.getElementById('fileInput').value = ''; // –û—á–∏—â–∞–µ–º input file

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è');
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('DOMContentLoaded', function() {
            initMobileMenu();
            initWebSocket();
            updateUserStatuses();

            const chatBox = document.getElementById("chat-box");
            if (chatBox) {
                chatBox.scrollTop = chatBox.scrollHeight;
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è Enter –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
            const messageInput = document.getElementById("messageInput");
            if (messageInput) {
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            }

            // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤ (–∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥)
            setInterval(requestChatsUpdate, 5000);

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ –∫–∞–∂–¥—ã–µ 20 —Å–µ–∫—É–Ω–¥
            setInterval(updateUserStatuses, 20000);
        });

        async function startChatWithUser(userId, username) {
            try {
                const response = await fetch('/api/create_chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        partner_id: userId  // –¢–µ–ø–µ—Ä—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –º–æ–¥–µ–ª–∏ CreateChatRequest
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                }

                const result = await response.json();
                if (result.chat_id) {
                    window.location.href = `/chat/${result.chat_id}`;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞:', error);
                alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —á–∞—Ç–∞: ${error.message}`);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–æ—Ñ–∏–ª—è
        async function openProfileModal(username) {
            try {
                const response = await fetch(`/api/user/${username}`);
                const userData = await response.json();

                const modalContent = `
                    <div class="modal-profile">
                        <img src="${userData.avatar_url || '/static/default_avatar.png'}"
                             class="modal-profile-avatar">
                        <h2 class="modal-profile-name">${userData.username}
                            ${userData.is_admin ? '<img src="/static/verified.png" class="admin-badge" title="–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä">' : ''}
                        </h2>
                        <div class="modal-profile-status">
                            <span class="status-dot ${userData.online ? 'online' : 'offline'}"></span>
                            ${userData.online ? '–æ–Ω–ª–∞–π–Ω' : `–±—ã–ª(–∞) ${userData.last_seen}`}
                        </div>
                        <p class="modal-profile-bio">${userData.bio || '–ù–µ—Ç—É –æ–ø–∏—Å–∞–Ω–∏—è.'}</p>
                    </div>
                `;

                document.getElementById('profileModalContent').innerHTML = modalContent;
                document.getElementById('profileModal').style.display = 'block';
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:', error);
            }
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–±–∏–ª—å–Ω—ã–º –º–µ–Ω—é
        function initMobileMenu() {
            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.getElementById('sidebarOverlay');

            if (menuToggle && sidebar && overlay) {
                menuToggle.addEventListener('click', function(e) {
                    e.stopPropagation();
                    this.classList.toggle('active');
                    sidebar.classList.toggle('active');
                    overlay.classList.toggle('active');
                });

                overlay.addEventListener('click', function() {
                    sidebar.classList.remove('active');
                    overlay.classList.remove('active');
                    menuToggle.classList.remove('active');
                });

                // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –ø—É–Ω–∫—Ç
                document.querySelectorAll('.sidebar a').forEach(link => {
                    link.addEventListener('click', function() {
                        sidebar.classList.remove('active');
                        overlay.classList.remove('active');
                        menuToggle.classList.remove('active');
                    });
                });
            }
        }

        document.getElementById('messageInput')?.addEventListener('focus', function() {
            setTimeout(() => {
                window.scrollTo(0, document.body.scrollHeight);
            }, 300);
        });

        document.getElementById("messageInput")?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        function closeProfileModal() {
            document.getElementById('profileModal').style.display = 'none';
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        document.addEventListener('DOMContentLoaded', function() {
            // –ö–ª–∏–∫ –ø–æ username –≤ —à–∞–ø–∫–µ —á–∞—Ç–∞
            document.querySelector('.chat-title')?.addEventListener('click', function() {
                openProfileModal(currentPartner);
            });

            // –ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ –∑–∞–∫—Ä—ã—Ç–∏—è
            document.querySelector('.close-modal')?.addEventListener('click', closeProfileModal);

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –æ–∫–Ω–∞
            document.querySelector('.modal-blur-bg')?.addEventListener('click', closeProfileModal);

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ ESC
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeProfileModal();
                }
            });
        });

        // –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        const userSearch = document.getElementById('userSearch');
        const searchResults = document.getElementById('searchResults');
        let searchTimeout = null;

        userSearch.addEventListener('input', function() {
            clearTimeout(searchTimeout);

            const query = this.value.trim();
            if (query.length < 2) {
                searchResults.innerHTML = '';
                searchResults.style.display = 'none';
                return;
            }

            searchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`/api/search_users?query=${encodeURIComponent(query)}`);
                    const users = await response.json();

                    if (users.length > 0) {
                        let html = '';
                        users.forEach(user => {
                            html += `
                            <div class="search-result-item" onclick="startChatWithUser(${user.id}, '${user.username}')">
                                <img src="${user.avatar_url || '/static/default_avatar.png'}" class="search-result-avatar">
                                <span class="search-result-username">${user.username}</span>
                                ${user.is_admin ? '<img src="/static/verified.png" class="admin-badge" title="–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä">' : ''}
                                <span class="status-dot ${user.online ? 'online' : 'offline'}"></span>
                            </div>`;
                        });

                        searchResults.innerHTML = html;
                        searchResults.style.display = 'block';
                    } else {
                        searchResults.innerHTML = '<div class="no-results">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                        searchResults.style.display = 'block';
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
                }
            }, 300);
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –ø–æ–ª—è –ø–æ–∏—Å–∫–∞
        document.addEventListener('click', function(e) {
            if (!userSearch.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.style.display = 'none';
            }
        })
    </script>
{% endblock %}